<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/profile.css">
    <title>Perfil - Airbnb</title>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">airbnb</a>
            <div class="user-menu">
                <img src="/img/default-avatar.jpg" 
                     alt="Usuario" 
                     class="user-avatar" id="header-avatar">
                <button onclick="cerrarSesion()" class="edit-button" style="margin-left: 10px;">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="breadcrumb">
                <a href="/">Inicio</a> > Cuenta > Perfil personal
            </div>
            <h1 class="profile-title">Perfil personal</h1>
            <p class="profile-subtitle">Esta es tu informaci√≥n personal de Airbnb</p>
        </div>

        <#if needsEmailFromJS?? && needsEmailFromJS>
            <!-- Loading State - JavaScript manejar√° la carga -->
            <div id="loading-state" style="text-align: center; padding: 50px;">
                <div style="font-size: 18px; color: #666;">Cargando perfil...</div>
            </div>

            <!-- Error State -->
            <div id="error-state" style="display: none; text-align: center; padding: 50px;">
                <div style="font-size: 18px; color: #dc3545; margin-bottom: 20px;">
                    <#if error??>
                        ${error}
                    <#else>
                        Error al cargar el perfil
                    </#if>
                </div>
                <button onclick="location.reload()" class="edit-button">
                    Intentar de nuevo
                </button>
                <button onclick="cerrarSesion()" class="secondary-button" style="margin-left: 10px;">
                    Cerrar Sesi√≥n
                </button>
            </div>

        <#else>
            <!-- Profile Content - Datos desde el servidor -->
            <div class="profile-content">
                <!-- Sidebar -->
                <aside class="profile-sidebar">
                    <img src="/img/default-avatar.jpg" 
                         alt="${nombreCompleto!'Usuario'}" 
                         class="profile-image">
                    
                    <h2 class="profile-name">${nombreCompleto!'Usuario'}</h2>
                    
                    <div class="profile-verified">
                        <span class="verification-badge">‚úì</span>
                        Identidad verificada
                    </div>

                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-icon">‚≠ê</span>
                            <span>Nuevo usuario</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">üè†</span>
                            <span>
                                <#if a√±oRegistro??>
                                    Miembro desde ${a√±oRegistro}
                                <#else>
                                    Miembro desde 2024
                                </#if>
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">üìç</span>
                            <span>Espa√±a</span>
                        </div>
                    </div>

                    <button class="edit-button" style="margin-top: 24px;" onclick="editarPerfil()">
                        Editar perfil
                    </button>
                </aside>

                <!-- Main Profile Info -->
                <div class="profile-main">
                    <!-- Informaci√≥n Personal -->
                    <section class="section">
                        <h3 class="section-title">Informaci√≥n personal</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Nombre completo</span>
                                <span class="info-value">
                                    <#if nombreCompleto?? && nombreCompleto?trim != "" && nombreCompleto != "Usuario">
                                        ${nombreCompleto}
                                    <#else>
                                        <span class="no-data">No especificado</span>
                                    </#if>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email</span>
                                <span class="info-value">
                                    <#if email??>
                                        ${email}
                                    <#else>
                                        <span class="no-data">No especificado</span>
                                    </#if>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Tel√©fono</span>
                                <span class="info-value">
                                    <#if telefono?? && telefono?trim != "">
                                        ${telefono}
                                    <#else>
                                        <span class="no-data">No especificado</span>
                                    </#if>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Fecha de nacimiento</span>
                                <span class="info-value">
                                    <#if fechaNacimiento??>
                                        <#-- Formatear fecha de nacimiento si existe -->
                                        ${fechaNacimiento?string("dd 'de' MMMM 'de' yyyy")}
                                    <#else>
                                        <span class="no-data">No especificado</span>
                                    </#if>
                                </span>
                            </div>
                        </div>
                    </section>

                    <!-- Acerca de m√≠ -->
                    <section class="section">
                        <h3 class="section-title">Acerca de m√≠</h3>
                        <p class="bio-text">
                            <#if biografia?? && biografia?trim != "">
                                ${biografia}
                            <#else>
                                No hay biograf√≠a disponible.
                            </#if>
                        </p>
                        <button class="secondary-button" style="margin-top: 16px;" onclick="editarBiografia()">
                            Editar descripci√≥n
                        </button>
                    </section>

                    <!-- Verificaciones -->
                    <section class="section">
                        <h3 class="section-title">Verificaciones</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">‚úì Email verificado</span>
                                <span class="info-value">
                                    <#if email??>
                                        ${email}
                                    <#else>
                                        No verificado
                                    </#if>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">
                                    <#if telefono?? && telefono?trim != "">
                                        ‚úì Tel√©fono verificado
                                    <#else>
                                        ‚è≥ Tel√©fono
                                    </#if>
                                </span>
                                <span class="info-value">
                                    <#if telefono?? && telefono?trim != "">
                                        ${telefono}
                                    <#else>
                                        <span class="no-data">Pendiente de verificaci√≥n</span>
                                    </#if>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">‚è≥ Documento de identidad</span>
                                <span class="info-value no-data">Pendiente de verificaci√≥n</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">‚úì Perfil completo</span>
                                <span class="info-value">
                                    <#if completitudPerfil??>
                                        ${completitudPerfil}% completado
                                    <#else>
                                        En progreso
                                    </#if>
                                </span>
                            </div>
                        </div>
                    </section>

                    <!-- Actividad reciente -->
                    <section class="section">
                        <h3 class="section-title">Actividad reciente</h3>
                        <div class="reviews-grid">
                            <div class="review-card">
                                <div class="review-header">
                                    <div class="reviewer-avatar"></div>
                                    <div class="reviewer-info">
                                        <div class="reviewer-name">Sistema</div>
                                        <div class="review-date">
                                            <#if a√±oRegistro??>
                                                ${a√±oRegistro}
                                            <#else>
                                                2024
                                            </#if>
                                        </div>
                                    </div>
                                </div>
                                <p class="review-text">
                                    ¬°Bienvenido a Airbnb! Tu perfil est√° 
                                    <#if completitudPerfil?? && (completitudPerfil >= 80)>
                                        casi completo.
                                    <#elseif completitudPerfil?? && (completitudPerfil >= 50)>
                                        en progreso. Completa m√°s informaci√≥n para una mejor experiencia.
                                    <#else>
                                        iniciado. Completa tu informaci√≥n personal para tener acceso a todas las funcionalidades.
                                    </#if>
                                </p>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </#if>
    </main>

    <script>
        // Funci√≥n para cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('userEmail');
                localStorage.removeItem('usuarioLogueado');
                window.location.href = '/login';
            }
        }

        // Funci√≥n para editar perfil
        function editarPerfil() {
            alert('Funcionalidad de edici√≥n en desarrollo. Pr√≥ximamente disponible.');
        }

        // Funci√≥n para editar biograf√≠a
        function editarBiografia() {
            const biografiaActual = '${biografia!""}';
            const nuevaBiografia = prompt('Introduce tu nueva biograf√≠a:', biografiaActual);
            if (nuevaBiografia !== null) {
                // Aqu√≠ se har√≠a una llamada al servidor para actualizar la biograf√≠a
                alert('Funcionalidad de edici√≥n en desarrollo. Pr√≥ximamente disponible.');
            }
        }

        // Solo ejecutar JavaScript si necesitamos obtener el email desde localStorage
        <#if needsEmailFromJS?? && needsEmailFromJS>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== CARGANDO PERFIL DESDE JAVASCRIPT ===');
            
            // Verificar sesi√≥n
            const usuarioLogueado = localStorage.getItem('usuarioLogueado');
            const userEmail = localStorage.getItem('userEmail');
            
            console.log('Usuario logueado:', usuarioLogueado);
            console.log('Email guardado:', userEmail);
            
            if (usuarioLogueado !== 'true' || !userEmail) {
                console.log('Sesi√≥n inv√°lida, mostrando error...');
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                
                // Redirigir despu√©s de 3 segundos
                setTimeout(() => {
                    window.location.href = '/login';
                }, 3000);
                return;
            }
            
            // Redirigir con el email como par√°metro
            console.log('Redirigiendo con email:', userEmail);
            window.location.href = '/profile?email=' + encodeURIComponent(userEmail);
        });
        </#if>

        // Verificaci√≥n peri√≥dica de sesi√≥n
        setInterval(function() {
            const usuarioLogueado = localStorage.getItem('usuarioLogueado');
            if (usuarioLogueado !== 'true') {
                window.location.href = '/login';
            }
        }, 60000); // Verificar cada minuto

        // Debug: Mostrar informaci√≥n del usuario en consola
        <#if !needsEmailFromJS?? || !needsEmailFromJS>
        console.log('=== DATOS DEL PERFIL CARGADOS ===');
        console.log('Nombre:', '${nombreCompleto!"No disponible"}');
        console.log('Email:', '${email!"No disponible"}');
        console.log('Tel√©fono:', '${telefono!"No disponible"}');
        console.log('Completitud:', '${completitudPerfil!0}%');
        </#if>
    </script>
</body>
</html>